<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retrato Interactivo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <!-- ml5 estable v0.12.2 -->
  <script src="https://cdn.jsdelivr.net/npm/ml5@0.12.2/dist/ml5.min.js"></script>
</head>

<body style="margin:0; overflow:hidden; background:#000;">
<script>
let video;
let faceapi;
let detections = [];
let modeloListo = false;

function setup() {
  // Ajusta tama√±o del canvas seg√∫n pantalla
  const w = windowWidth < 700 ? windowWidth : 640;
  const h = windowHeight < 500 ? windowHeight : 480;
  createCanvas(w, h);

  // Captura de video con c√°mara frontal
  video = createCapture({
    video: {
      facingMode: "user",
      width: w,
      height: h
    },
    audio: false
  }, () => {
    console.log("üé• C√°mara lista");
  });
  
  video.size(w, h);
  video.hide();

  // Configuraci√≥n de FaceAPI
  const options = {
    withLandmarks: true,
    withExpressions: false,
    withDescriptors: false,
  };
  
  faceapi = ml5.faceApi(video, options, modelReady);

  textAlign(CENTER);
  textSize(20);
  fill(255);
}

function modelReady() {
  console.log("‚úÖ Modelo cargado correctamente");
  modeloListo = true;
  faceapi.detect(gotResults);
}

function gotResults(err, result) {
  if (err) {
    console.error(err);
    return;
  }
  detections = result;
  faceapi.detect(gotResults);
}

function draw() {
  background(0);

  if (!video.loadedmetadata) {
    text("üé• Iniciando c√°mara...", width / 2, height / 2);
    return;
  }

  if (!modeloListo) {
    text("üß† Cargando modelo de rostro...", width / 2, height / 2);
    return;
  }

  // Mostrar video como espejo
  push();
  translate(width, 0);
  scale(-1, 1);
  image(video, 0, 0, width, height);
  pop();

  // Dibujar puntos faciales
  if (detections.length > 0) {
    const puntos = detections[0].landmarks.positions;
    noStroke();
    fill(255, 100, 150, 160);
    for (let p of puntos) {
      ellipse(width - p.x, p.y, 8, 8);
    }
  } else {
    fill(255);
    text("Mira hacia la c√°mara üëÄ", width / 2, height / 2);
  }
}

function windowResized() {
  // Ajustar canvas al girar pantalla o cambiar tama√±o
  resizeCanvas(windowWidth < 700 ? windowWidth : 640, windowHeight < 500 ? windowHeight : 480);
}
</script>
</body>
</html>
