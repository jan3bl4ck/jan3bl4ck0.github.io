<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Retrato Interactivo</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>
  <script src="https://unpkg.com/ml5@latest/dist/ml5.min.js"></script>
</head>

<body style="margin:0; overflow:hidden; background:#000;">
<script>
let videoEl;
let faceapi;
let detections = [];
let modeloListo = false;
// let camaraLista = false; // <--- ELIMINAMOS ESTA LÍNEA

function setup() {
  const w = windowWidth < 700 ? windowWidth : 640;
  const h = windowHeight < 500 ? windowHeight : 480;
  createCanvas(w, h);

  // Crear elemento de video HTML oculto
  // <--- ELIMINAMOS EL CALLBACK (LA FUNCIÓN DE FLECHA) DE AQUÍ
  videoEl = createCapture({
    video: { facingMode: "user", width: w, height: h },
    audio: false
  });

  // Opcional: puedes verificar en consola cuando esté lista
  videoEl.elt.onloadedmetadata = () => {
    console.log("🎥 Cámara lista (metadata cargada)");
  }

  videoEl.size(w, h);
  videoEl.hide();

  // Inicializar faceApi
  const options = {
    withLandmarks: true,
    withExpressions: false,
    withDescriptors: false
  };

  faceapi = ml5.faceapi(videoEl.elt, options, modelReady);

  textAlign(CENTER);
  textSize(20);
  fill(255);
}

function modelReady() {
  console.log("✅ Modelo cargado correctamente");
  modeloListo = true;
  faceapi.detect(videoEl.elt, gotResults);
}

function gotResults(err, result) {
  if (err) {
    console.error(err);
    return;
  }
  detections = result;
  faceapi.detect(videoEl.elt, gotResults);
}

function draw() {
  background(0);

  // <--- ¡ESTA ES LA CORRECCIÓN IMPORTANTE!
  // Usamos videoEl.width === 0 para saber si el video aún no está listo.
  if (videoEl.width === 0) {
    text("🎥 Iniciando cámara...", width / 2, height / 2);
    return;
  }

  if (!modeloListo) {
    text("🧠 Cargando modelo de rostro...", width / 2, height / 2);
    return;
  }

  // Dibujar video en canvas como espejo
  push();
  translate(width, 0);
  scale(-1, 1);
  image(videoEl, 0, 0, width, height);
  pop();

  // Dibujar puntos faciales
  if (detections.length > 0) {
    const puntos = detections[0].landmarks.positions;
    noStroke();
    fill(255, 100, 150, 160);
    for (let p of puntos) {
      ellipse(width - p.x, p.y, 8, 8);
    }
  } else {
    fill(255);
    text("Mira hacia la cámara 👀", width / 2, height / 2);
  }
}

function windowResized() {
  resizeCanvas(windowWidth < 700 ? windowWidth : 640, windowHeight < 500 ? windowHeight : 480);
}
</script>
</body>
</html>
